---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE}
library(tidyverse)
```
```{r message=FALSE}
library(ggplot2)
```
# Import Files
```{r message=FALSE}
coffeeDrug <- read_table("coffee_drug_1114_1165.dat")
coffeeDrug$SY <- as.character(coffeeDrug$SY)
coffeeDrug$GE <- as.character(coffeeDrug$GE)
coffeeDrug$VEND <- as.character(coffeeDrug$VEND)
coffeeDrug$ITEM <- as.character(coffeeDrug$ITEM)
```
```{r message=FALSE}
coffeeGroc <- read_table("coffee_groc_1114_1165.dat")
coffeeGroc$SY <- as.character(coffeeGroc$SY)
coffeeGroc$GE <- as.character(coffeeGroc$GE)
coffeeGroc$VEND <- as.character(coffeeGroc$VEND)
coffeeGroc$ITEM <- as.character(coffeeGroc$ITEM)
```
```{r message=FALSE}
drugPanel <- read.table("coffee_PANEL_DR_1114_1165.dat", header = TRUE)
```
```{r message=FALSE}
grocPanel <- read.table("coffee_PANEL_GR_1114_1165.dat", header = TRUE)
```
```{r message=FALSE}
massPanel <- read.table("coffee_PANEL_MA_1114_1165.dat", header = TRUE)
```
```{r message=FALSE}
stores <- read_table('Delivery_Stores.dat')
```
```{r message=FALSE}
prodCoffee <- readxl::read_xls('prod_coffee.xls')
```
```{r message=FALSE}
demography <- read.csv('ads demo3(1).csv')
```

# Join grocery scanner data with prod
```{r message=FALSE}
grocProd <- dplyr::left_join(coffeeGroc, prodCoffee, 
                             by = c('SY'='SY','GE'='GE','VEND'='VEND','ITEM'='ITEM'))
```
# Join drug scanner data with prod
```{r message=FALSE}
drugProd <- dplyr::left_join(coffeeDrug, prodCoffee, 
                             by = c('SY'='SY','GE'='GE','VEND'='VEND','ITEM'='ITEM'))
```

#Join merged grocery data with delivery stores data
```{r message=FALSE}
groceryStores <- dplyr::left_join(grocProd, stores, by='IRI_KEY')
```

#Join merged drug data with delivery stores data
```{r message=FALSE}
drugStores <- dplyr::left_join(drugProd, stores, by='IRI_KEY')
```

# Creating vector of columns to be dropped from the dataset
```{r message=FALSE}
dropCols <- c("SY","GE","VEND","ITEM","L1","L9","Level","*STUBSPEC 1440RC                                                         00004","FAT CONTENT","FORM...21","EST_ACV","Open","Clsd")
```

# Drop unnecessary columns from merged data
```{r message=FALSE}
groceryStores <- select(groceryStores, -dropCols)
```

```{r message=FALSE}
drugStores <- select(drugStores, -dropCols)
```

# Top 6 brands by dollar sales
```{r message=FALSE}
top6Brands <- groceryStores %>% 
  group_by(L5) %>% 
  summarise(dollar_sales = sum(DOLLARS)) %>% 
  arrange(desc(dollar_sales)) %>% 
  top_n(n=6)
```

```{r message=FALSE}
ggplot(data=top6Brands, aes(reorder(L5,-dollar_sales),dollar_sales)) + 
  geom_bar(stat = "identity", color="black") +
  xlab("Brand") + 
  ylab("Sales") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Top brands by dollar sales within KRAFT FOOD INC.
```{r message=FALSE}
groceryStores %>% 
  filter(L4=="KRAFT FOODS INC.") %>%
  group_by(L5) %>% 
  summarise(dollar_sales = sum(DOLLARS)) %>% 
  arrange(desc(dollar_sales)) %>%
  top_n(n=5)
```

# Top brands selling Ground Coffee by dollar sales within KRAFT FOOD INC.
```{r message=FALSE}
groceryStores %>% 
  filter(L4=="KRAFT FOODS INC.", L2=="GROUND COFFEE") %>%
  group_by(L5) %>% 
  summarise(dollar_sales = sum(DOLLARS)) %>% 
  arrange(desc(dollar_sales)) %>%
  top_n(n=5)
```

# Top brands selling Ground Coffee by dollar sales within KRAFT FOOD INC. by region
```{r message=FALSE}
groceryStores %>% 
  filter(L4=="KRAFT FOODS INC.", L2=="GROUND COFFEE", L5=="MAXWELL HOUSE") %>%
  group_by(Market_Name) %>% 
  summarise(dollar_sales = sum(DOLLARS)) %>% 
  arrange(desc(dollar_sales)) %>%
  top_n(n=10)
```

```{r message=FALSE}
groceryStores %>% 
  filter(L4=="KRAFT FOODS INC.", L2=="GROUND COFFEE", L5=="MAXWELL HOUSE") %>%
  group_by(Market_Name, MskdName) %>% 
  summarise(dollar_sales = sum(DOLLARS)) %>% 
  arrange(desc(dollar_sales), .by_group=TRUE) %>%
  top_n(5)
```

# Sale of number of units per week
```{r message=FALSE}
weeklySales <- groceryStores %>%
  filter(L4=="KRAFT FOODS INC.", L2=="GROUND COFFEE", L5=="MAXWELL HOUSE") %>%
  group_by(WEEK) %>%
  summarise(weekly_sales = sum(UNITS))
weeklySales
```

# Line chart of weekly sales
```{r message=FALSE}
ggplot(weeklySales, aes(WEEK,weekly_sales)) +
  geom_line(stat="identity") +
  xlab("Week") +
  ylab("Units Sold")
```

# Weekly price per per ounce
```{r message=FALSE}
weeklyPpoz <- groceryStores %>%
  filter(L4=="KRAFT FOODS INC.", L2=="GROUND COFFEE", L5=="MAXWELL HOUSE") %>%
  group_by(WEEK) %>%
  summarise(weekly_ppoz = mean((DOLLARS)/(UNITS*VOL_EQ*16)))
weeklyPpoz
```

# Line chart of weekly price per ounce
```{r message=FALSE}
ggplot(weeklyPpoz, aes(WEEK,weekly_ppoz)) +
  geom_line(stat="identity") +
  xlab("Week") +
  ylab("Avg Price/ounce")
```

# Correlation between average price per ounce and number of units sold per week
```{r message=FALSE}
cor(weeklySales$weekly_sales, weeklyPpoz$weekly_ppoz)
```
We observe that there is a strong correlation between number of units sold with price per ounce

```{r message=FALSE}
ggplot() +
  geom_line(data = weeklySales, aes(WEEK,log(weekly_sales)),color="darkred") +
  xlab("Week") +
  geom_line(data = weeklyPpoz, aes(WEEK,weekly_ppoz*30), color="steelblue") +
  scale_y_continuous(name="Units Sold", sec.axis=sec_axis(~./1,name="Avg Price/ounce")) +
  theme(
    axis.title.y.left=element_text(color="darkred"),
    axis.text.y.left=element_text(color="darkred"),
    axis.title.y.right=element_text(color="steelblue"),
    axis.text.y.right=element_text(color="steelblue")
  )

```

It is evident that there is a sales increased during the week when the avg price per ounce was reduced.

# Create a subset of data for Maxwell House ground coffee
```{r message= FALSE}
grocMaxwell <- groceryStores %>%
  filter(L2=="GROUND COFFEE", L5=="MAXWELL HOUSE")
```
```{r message=FALSE}
drugMaxwell <- drugStores %>%
  filter(L2=="GROUND COFFEE", L5=="MAXWELL HOUSE")
```

# Create a new column with weight of annual share of display variable(D) for each group of UPC, convert F and PR to dummy variables
```{r message=FALSE}
wtGrocMaxwell <- grocMaxwell %>%
  group_by(UPC) %>%
  mutate(wt = sum(D)/sum(.$D),
         feature = ifelse(F=="NONE",0,1),
         reduced_price = ifelse(PR==0, 0, 1))
```

# Dataset with weekly averages to perform regression
```{r message=FALSE}
regGrocData <- wtGrocMaxwell %>% 
  group_by(WEEK) %>%
  summarise(sales = weighted.mean(DOLLARS/UNITS,wt),
            ppoz = mean((DOLLARS)/(UNITS*VOL_EQ*16)),
            display = mean(D),
            featured = mean(feature),
            pr_reduced = mean(reduced_price))
```

